# DirectX 12 Validation Audit Report

## 1. Executive Verdict
- Overall Risk: **Fail** (Critical blockers remain in the D3D12 backend for resource initialization, compute workloads, and CPU readback).
- Severity distribution: 4 Critical / 3 High / 6 Medium (0 Low) across 13 findings.
- Module distribution: Device & Context (3), CommandBuffer & Queue (4), Compute pipeline (4), Texture/Framebuffer (2), Descriptor management (1).
- Full issue summary (ordered by severity with priority guidance):
  1. [Critical][DX12-001] GPU-only buffer uploads return `Result::Code::Unimplemented`, blocking default-heap vertex/index/constant buffer initialization (`src/igl/d3d12/Buffer.cpp:82`) – static resource creation fails; fix priority **P0**.
  2. [Critical][DX12-002] CPU readback path `CommandBuffer::copyTextureToBuffer` is stubbed (`src/igl/d3d12/CommandBuffer.cpp:292`), so any texture download falls back to no-op; fix priority **P0**.
  3. [Critical][DX12-003] `ComputeCommandEncoder::bindPushConstants` is a stub while `Device::hasFeature(PushConstants)` reports true (`src/igl/d3d12/ComputeCommandEncoder.cpp:192`, `src/igl/d3d12/Device.cpp:1666`), breaking compute shaders that rely on push constants; fix priority **P0**.
  4. [Critical][DX12-004] Compute CBV descriptor table binding is unfinished—the encoder only logs and never binds descriptors (`src/igl/d3d12/ComputeCommandEncoder.cpp:163-175`), so uniform buffers are invisible to compute workloads; fix priority **P0**.
  5. [High][DX12-005] `CommandQueue::submit` enables `DXGI_PRESENT_ALLOW_TEARING` when VSync is disabled without honoring the factory capability flag (`src/igl/d3d12/CommandQueue.cpp:86-93`, `src/igl/d3d12/D3D12Context.cpp:229-241`), causing invalid Present calls on platforms without tearing support; fix priority **P1**.
  6. [High][DX12-006] Device creation insists on feature level 12_0 for hardware adapters and only falls back to WARP 11_0 (`src/igl/d3d12/D3D12Context.cpp:148-169`), rejecting legitimate FL 11_0/11_1 hardware; fix priority **P1**.
  7. [High][DX12-007] Descriptor exhaustion returns `UINT32_MAX` but render encoders proceed to create views with null handles (`src/igl/d3d12/DescriptorHeapManager.cpp:89`, `src/igl/d3d12/RenderCommandEncoder.cpp:88-106`), risking undefined descriptors and GPU faults; fix priority **P1**.
  8. [Medium][DX12-008] `Device::destroy(SamplerHandle)` is a stub (`src/igl/d3d12/Device.cpp:72`), leaking sampler descriptors and preventing pool reuse; fix priority **P1**.
  9. [Medium][DX12-009] Depth/stencil readback helpers remain TODOs (`src/igl/d3d12/Framebuffer.cpp:241-256`), so diagnostic captures and tests cannot validate depth buffers; fix priority **P1**.
 10. [Medium][DX12-010] `Texture::uploadCube` returns `Result::Code::Unimplemented` (`src/igl/d3d12/Texture.cpp:335-339`), blocking cubemap authoring; fix priority **P1**.
 11. [Medium][DX12-011] `CommandBuffer::waitUntilScheduled/Completed` are stubs (`src/igl/d3d12/CommandBuffer.cpp:134-148`), so API expectations for CPU synchronization are unmet; fix priority **P2**.
 12. [Medium][DX12-012] `ComputeCommandEncoder::bindBytes` is unimplemented (`src/igl/d3d12/ComputeCommandEncoder.cpp:351-354`), preventing raw parameter uploads for compute; fix priority **P2**.
 13. [Medium][DX12-013] Transient push-constant buffers accumulate because `CommandBuffer::trackTransientBuffer` is never cleared between submissions (`src/igl/d3d12/CommandBuffer.h:64-78`), leading to unbounded CPU memory growth; fix priority **P2**.

## 2. Findings Register
| ID | Severity | Category | Location | Description | Official Reference | Recommendation | Status |
|----|----------|----------|----------|-------------|--------------------|----------------|--------|
| DX12-001 | Critical | Resource Upload | `src/igl/d3d12/Buffer.cpp:82` | Default-heap buffer uploads return `Result::Code::Unimplemented`, so GPU-only buffers cannot be initialized. | Doc: [MS Learn – Uploading resources](https://learn.microsoft.com/en-us/windows/win32/direct3d12/uploading-resources#uploading-to-the-default-heap); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloTexture/D3D12HelloTexture.cpp | Implement staging uploads (`UpdateSubresources` + copy list) mirroring Vulkan staging path before returning success. | Open |
| DX12-002 | Critical | Readback | `src/igl/d3d12/CommandBuffer.cpp:292` | `copyTextureToBuffer` is stubbed, so CPU readback requests never copy texels. | Doc: [MS Learn – Texture copy operations](https://learn.microsoft.com/en-us/windows/win32/direct3d12/texture-copy-operations); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloTexture/D3D12HelloTexture.cpp | Implement `CopyTextureRegion` into a readback buffer and plumb through `CommandQueue` fences, matching Vulkan/GL behavior. | Open |
| DX12-003 | Critical | Compute Push Constants | `src/igl/d3d12/ComputeCommandEncoder.cpp:192` | `bindPushConstants` logs "not yet implemented" even though `Device::hasFeature(PushConstants)` advertises support. | Doc: [MS Learn – Root constants](https://learn.microsoft.com/en-us/windows/win32/direct3d12/root-signatures#root-constants); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12nBodyGravity/D3D12nBodyGravity.cpp | Use `SetComputeRoot32BitConstants` for the reserved root parameter and honor offsets/lengths to match Vulkan push constant semantics. | Open |
| DX12-004 | Critical | Compute Uniforms | `src/igl/d3d12/ComputeCommandEncoder.cpp:163-175` | CBV binding for compute is unfinished (logs only), leaving uniform buffers unbound. | Doc: [MS Learn – Descriptor tables](https://learn.microsoft.com/en-us/windows/win32/direct3d12/descriptor-tables); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloConstBuffers/D3D12HelloConstBuffers.cpp | Allocate CBV descriptors, populate the table, and call `SetComputeRootDescriptorTable` so compute shaders see uniform data. | Open |
| DX12-005 | High | Swapchain | `src/igl/d3d12/CommandQueue.cpp:86-93` | Tear flag applied unconditionally when VSync is disabled, ignoring `allowTearing` capability query. | Doc: [MS Learn – Detecting tearing support](https://learn.microsoft.com/en-us/windows/win32/direct3ddxgi/variable-refresh-rate-displays#detecting-tearing-support); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloWindow/D3D12HelloWindow.cpp | Cache `allowTearing` in the context and guard `Present` flags, falling back to `syncInterval=1` when unsupported. | Open |
| DX12-006 | High | Device Init | `src/igl/d3d12/D3D12Context.cpp:148-169` | Hardware adapters are only tested at FL 12_0, skipping valid FL 11_x devices. | Doc: [MS Learn – D3D12 feature levels](https://learn.microsoft.com/en-us/windows/win32/direct3d12/feature-levels); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloTriangle/D3D12HelloTriangle.cpp | Iterate feature levels {12_2 .. 11_0} and accept the highest supported level before falling back to WARP. | Open |
| DX12-007 | High | Descriptor Management | `src/igl/d3d12/DescriptorHeapManager.cpp:89` | Exhausted descriptor heaps return `UINT32_MAX`, but render encoders still request handles, yielding null descriptors. | Doc: [MS Learn – Descriptor heaps](https://learn.microsoft.com/en-us/windows/win32/direct3d12/descriptor-heaps); Sample: microsoft/DirectX-Graphics-Samples/MiniEngine/Core/DescriptorHeap.cpp | Detect exhaustion, surface an error/expand pool, and prevent `Create*View` calls with invalid handles. | Open |
| DX12-008 | Medium | Lifetime | `src/igl/d3d12/Device.cpp:72` | `Device::destroy(SamplerHandle)` is a stub, leaking sampler descriptors. | Doc: [MS Learn – Descriptor heaps](https://learn.microsoft.com/en-us/windows/win32/direct3d12/descriptor-heaps); Sample: microsoft/DirectX-Graphics-Samples/MiniEngine/Core/DescriptorHeap.cpp | Return handles to `DescriptorHeapManager` so samplers recycle like Vulkan/GL counterparts. | Open |
| DX12-009 | Medium | Diagnostics | `src/igl/d3d12/Framebuffer.cpp:241-256` | Depth/stencil readback helpers are TODOs, preventing parity with Vulkan/GL debugging. | Doc: [MS Learn – Readback resources](https://learn.microsoft.com/en-us/windows/win32/direct3d12/readback-resources); Sample: microsoft/DirectX-Graphics-Samples/MiniEngine/Core/ReadBackBuffer.cpp | Implement `CopyTextureRegion` into readback buffers for depth/stencil targets and expose to tests. | Open |
| DX12-010 | Medium | Texture Upload | `src/igl/d3d12/Texture.cpp:335-339` | Cubemap uploads return `Result::Code::Unimplemented`. | Doc: [MS Learn – Texture data layout](https://learn.microsoft.com/en-us/windows/win32/direct3d12/uploading-resources#texture-data-layout); Sample: microsoft/DirectX-Graphics-Samples/MiniEngine/Core/Texture.cpp | Follow the Vulkan cubemap upload path (layered subresource copies) and enable unit tests. | Open |
| DX12-011 | Medium | Synchronization API | `src/igl/d3d12/CommandBuffer.cpp:134-148` | `waitUntilScheduled/Completed` no-op, violating IGL API expectations. | Doc: [MS Learn – Command queues & synchronization](https://learn.microsoft.com/en-us/windows/win32/direct3d12/direct3d-12-command-queues#synchronization); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12HelloWorld/src/HelloTriangle/D3D12HelloTriangle.cpp | Track per-command-buffer fences and implement waits consistent with Vulkan timeline fences. | Open |
| DX12-012 | Medium | Compute Params | `src/igl/d3d12/ComputeCommandEncoder.cpp:351-354` | `bindBytes` is unimplemented, blocking raw compute parameter uploads. | Doc: [MS Learn – Structured and byte address buffers](https://learn.microsoft.com/en-us/windows/win32/direct3d12/byteaddressbuffer); Sample: microsoft/DirectX-Graphics-Samples/Samples/Desktop/D3D12nBodyGravity/D3D12nBodyGravity.cpp | Allocate transient upload buffers and issue `CopyBufferRegion` or map writes analogous to Vulkan `bindBytes`. | Open |
| DX12-013 | Medium | Memory Lifetime | `src/igl/d3d12/CommandBuffer.h:64-78` | Transient buffers recorded for push constants never clear, leaking across submissions. | Doc: [MS Learn – Memory management](https://learn.microsoft.com/en-us/windows/win32/direct3d12/memory-management); Sample: microsoft/DirectX-Graphics-Samples/MiniEngine/Core/DynamicUploadHeap.cpp | Reset `transientBuffers_` after queue submission (once GPU work completes) to mirror Vulkan ring-buffer recycling. | Open |

## 3. Detailed Analyses (per Analyst)
### Analyst-A – API & Initialization
- DX12-006: `createDevice` enforces FL 12_0, diverging from Microsoft guidance and Vulkan/GL fallback strategies.
- DX12-005: Tearing support flag is ignored during Present, risking DXGI errors when `allowTearing` is false.
- Observed consistent debug-layer enablement and info-queue filtering; no additional blockers.

### Analyst-B – Resources & Memory Lifetime
- DX12-001: Default-heap uploads missing, unlike Vulkan staging path; prevents static resource population.
- DX12-013: Transient buffer vector never clears, leading to growth per submission.
- DX12-009/010: Readback and cubemap uploads remain TODO, limiting asset/test parity with other backends.

### Analyst-C – Descriptors & Root Signatures
- DX12-007/008: Descriptor heap exhaustion and sampler destruction lack safeguards, unlike Vulkan descriptor pool handling.
- DX12-003/004: Root signatures reserve push constants and CBV tables, but compute binding code leaves them unused.
- `kMaxDescriptorSets`/heap sizes are hard-coded without querying binding tier (see Cross-API audit).

### Analyst-D – Command Queues & Synchronization
- DX12-002: CPU readback not wired; Vulkan/GL implement full path.
- DX12-011: CommandBuffer wait APIs are stubs; queue waits rely solely on??
